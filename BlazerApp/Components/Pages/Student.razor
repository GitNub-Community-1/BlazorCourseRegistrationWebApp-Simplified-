@page "/student"
@using BlazerApp.Models.Dtos
@using BlazerApp.Services.Interfaces
@rendermode InteractiveServer
@inject IStudentService StudentService
@inject ICourseService CourseService
@inject NavigationManager NavManager

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<div class="container mt-5 pb-5">
    <div class="header-section d-flex justify-content-between align-items-center p-4 mb-5 shadow-sm rounded-4 bg-white border-bottom border-primary border-3">
        <div>
            <h1 class="display-5 fw-bold text-dark mb-1">Студенты</h1>
            <p class="text-muted mb-0">Управление базой учащихся</p>
        </div>
        <button class="btn btn-primary btn-lg shadow-sm" @onclick="GoToCreate">
            <i class="bi bi-person-plus-fill me-2"></i> Добавить
        </button>
    </div>

    <div class="table-responsive shadow-lg rounded-4">
        <table class="table table-hover align-middle bg-white mb-0">
            <thead class="table-dark">
                <tr>
                    <th class="ps-4" style="width: 100px;">ID</th>
                    <th>ФИО</th>
                    <th>Курс</th>
                    <th class="text-end pe-4">Действия</th>
                </tr>
            </thead>
            <tbody>
                @if (students == null)
                {
                    <tr>
                        <td colspan="4" class="text-center p-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Загрузка данных...</p>
                        </td>
                    </tr>
                }
                else if (!students.Any())
                {
                    <tr>
                        <td colspan="4" class="text-center p-5 text-muted">Студенты не найдены</td>
                    </tr>
                }
                else
                {
                    @foreach (var student in students)
                    {
                        <tr class="student-row">
                            <td class="ps-4 fw-bold text-secondary">#@student.Id</td>
                            <td class="fw-bold text-dark">@student.FullName</td>
                            <td>
                                <span class="badge bg-info-subtle text-info border border-info px-3 py-2 rounded-pill">
                                    <i class="bi bi-book me-1"></i> 
                                    @GetCourseName(student.CourseId)
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <div class="btn-group shadow-sm">
                                    <button class="btn btn-outline-secondary btn-sm" title="Детали" @onclick="() => GoToDetails(student.Id)">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" title="Изменить" @onclick="() => GoToUpdate(student.Id)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" title="Удалить" @onclick="() => DeleteStudent(student.Id)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    .header-section {
        background: linear-gradient(to right, #ffffff, #f0f4ff);
    }
    .student-row:hover {
        background-color: #f8f9ff !important;
    }
    .badge {
        font-size: 0.9rem;
    }
</style>

@code {
    private List<StudentDto>? students;
    private Dictionary<int, string> courseNames = new();

    protected override async Task OnInitializedAsync()
    {
        var studentRes = await StudentService.GetStudentsAsync();
        students = studentRes?.Data ?? new List<StudentDto>();

       
        var courseRes = await CourseService.GetAllCoursesAsync();
        if (courseRes?.Data != null)
        {
            courseNames = courseRes.Data.ToDictionary(c => c.Id, c => c.Title);
        }
    }

    private string GetCourseName(int courseId)
    {
        return courseNames.TryGetValue(courseId, out var title) ? title : "Не записан в курсы";
    }

    private void GoToCreate()
    {
        NavManager.NavigateTo("/createstudent");
    }

    private void GoToUpdate(int id)
    {
        NavManager.NavigateTo($"/updatestudent/{id}");
    }

    private void GoToDetails(int id)
    {
        NavManager.NavigateTo($"/studentdetails/{id}");
    }

    private async Task DeleteStudent(int id)
    {
        var res = await StudentService.DeleteStudentAsync(id);
        if (res != null && res.StatusCode == 200)
        {
            students?.RemoveAll(s => s.Id == id);
            StateHasChanged();
        }
    }
}